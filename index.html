<html>
	<head>
		<script type="text/javascript">
			const MIN_PLAYERS = 2;
			const MAX_PLAYERS = 8;
			const GAMES_PER_MATCH = 6;

			var currentGroup;


			function initGroup(group) {
				for (var i = 0; i < group.players.length; i++) {
					var pA = group.players[i];
					for (var j = 0; j < group.players.length; j++) {
						var pB = group.players[j];
						if (pA.name != pB.name) {
							var found = false;
							for (var k = 0; k < group.matches.length; k++) {
								var m = group.matches[k];
								if ((m.p1 == pA.name && m.p2 == pB.name) || (m.p1 == pB.name && m.p2 == pA.name)) {
									found = true;
									break;
								}
							}
							if (!found) {
								var m = new Object();
								m.p1 = pA.name;
								m.p2 = pB.name;
								m.actualResult = "Not played";
								group.matches.push(m);
							}
						}
					}
				}
			}

			function resetPlayers(group) {
				group.players.forEach(function(p) {
					p.matchesPlayed = 0;
					p.points = 0;
					p.average = "-";
					p._2nd = 0;
					p._3rd = 0;
				});
			}

			function resetMatches(group) {
				group.matches.forEach(function(m) {
					m.speculativeResult = m.actualResult;
				});
			}

			function recalculateAndRedraw() {
				var group = currentGroup;
				resetPlayers(group);
				parseMatchesFromHTML(group);
				calculatePlayersAttributes(group);
				sortPlayers(group);
				drawMatches(group);
				drawStandings(group);
			}

			function parseMatchesFromHTML(group) {
				var matchesTable = document.getElementById('matchesTable');
				var matches = new Array();
				for (var i = 0; i < matchesTable.rows.length; i++) {
					var matchResultElement = matchesTable.rows[i].cells[1].childNodes[0];

					for (var j = 0; j < group.matches.length; j++) {
						var m = group.matches[j];
						if (m.p1 == matchResultElement.p1 && m.p2 == matchResultElement.p2) {
							m.speculativeResult = matchResultElement.value;
							break;
						}
					}
				}
			}

			function calculatePlayersAttributes(group) {
				for (var i = 0; i < group.players.length; i++) {
					var p = group.players[i];
					for (var j = 0; j < group.matches.length; j++) {
						var m = group.matches[j];
						if (m.p1 == p.name || m.p2 == p.name) {
							if (m.speculativeResult != "Not played") {
								p.points += ((m.p1 == p.name) ? m.speculativeResult : (GAMES_PER_MATCH - m.speculativeResult)) * 1;
								p.matchesPlayed++;
								p.average = p.matchesPlayed == 0 ? "-" : (p.points / p.matchesPlayed).toFixed(1);
							}
						}
					}
				}

				for (var i = 0; i < group.players.length; i++) {					
					var p = group.players[i];

					for (var j = 0; j < group.players.length; j++) {
						if (j != i && p.points == group.players.points) {
							for (var k = 0; k < group.matches.length; k++) {
								var m = group.matches[k];
								if (m.speculativeResult != "Not played" &&
									((m.p1 == p.name && m.p2 == group.players[j].name) || 
									(m.p2 == p.name && m.p1 == group.players[j].name))) {
									p._2nd += ((m.p1 == p.name) ? m.speculativeResult : (GAMES_PER_MATCH - matches[k].speculativeResult)) * 1;
									break;
								}
							}
						}
					}

					for (var j = 0; j < group.matches.length; j++) {						
						var m = group.matches[j];
						if (m.p1 == p.name || m.p2 == p.name) {
							if (m.speculativeResult != "Not played") {
								var oppName = (m.p1 == p.name) ? m.p2 : m.p1;
								var opp;
								for (var k = 0; k < group.players.length; k++) {
									if (group.players[k].name == oppName) {
										opp = group.players[k];
										break;
									}
								}
								p._3rd += ((m.p1 == p.name) ? m.speculativeResult : (GAMES_PER_MATCH - m.speculativeResult)) * opp.points;
							}
						}
					}
				}
			}



			function sortPlayers(group) {
				group.players = group.players.sort(function(a, b) {
					if (a.average != b.average) {
						return a.average < b.average;
					} else {
						if (a._2nd != b._2nd) {
							return a._2nd < b._2nd;
						} else {
							if (a._3rd != b._3rd) {
								return a._3rd < b._3rd;
							} else {
								return a.name > b.name;
							}
						}
					}
				});
			}

			function drawMatches(group) {
				document.getElementById('matchesTableDiv').innerHTML = "<table id=\"matchesTable\"></table>";
				var matchesTable = document.getElementById('matchesTable');

				group.matches.forEach(function(m) {
					var row = matchesTable.insertRow(matchesTable.rows.length);	
					row.insertCell(0).innerHTML = m.p1;


					var results = ["Not played"];
					for (var i = 0; i <= GAMES_PER_MATCH; i += 0.5) {
						results.push(i);
					}

					var cell = row.insertCell(1);
					var select = document.createElement("select");
					select.p1 = m.p1;
					select.p2 = m.p2;

					cell.appendChild(select);				

					for (var i = 0; i < results.length; i++) {
						var option = document.createElement("option");
						option.value = results[i];
						option.text = results[i];
						select.appendChild(option);
					}
					select.value = m.speculativeResult;
					select.setAttribute('onchange', 'recalculateAndRedraw()');

					row.insertCell(2).innerHTML = m.p2;
				});
			}

			function drawStandings(group) {
				var playersTableHTML = "<table id=\"playersTable\"><tr>"
					+ "<th>rank</th>"
					+ "<th>name</th>"
					+ "<th>average</th>"
					+ "<th>points</th>"
					+ "<th>#played</th>"
					+ "<th>2nd</th>"
					+ "<th>3rd</th>"
					+ "</tr></table>";
				document.getElementById('playersTableDiv').innerHTML = playersTableHTML;

				var playersTable = document.getElementById('playersTable');
				for (var i = playersTable.rows.length - 1; i > 0; i--) {
					playersTable.deleteRow(i);
				}
				for (var i = 0; i < group.players.length; i++) {
					var p = group.players[i];
					var row = playersTable.insertRow(i + 1);
					row.insertCell(0).innerHTML = i + 1;
					row.insertCell(1).innerHTML = p.name; 
					row.insertCell(2).innerHTML = p.average;
					row.insertCell(3).innerHTML = p.points; 
					row.insertCell(4).innerHTML = p.matchesPlayed;
					row.insertCell(5).innerHTML = p._2nd; 
					row.insertCell(6).innerHTML = p._3rd;
				}
			}


			function checkInput() {				
				document.getElementById('errorSpan').innerHTML = "";

				var playersToCheck = new Array();

				var lines = document.getElementById('playersTextArea').value.split('\n');
				for(var i = 0; i < lines.length; i++){
					if (lines[i] != "") {
						var alreadyIn = false;
						for (var j = 0; j < playersToCheck.length; j++){
							if (playersToCheck[j] == lines[i]) {
								alreadyIn = true;
								break;
							}
						}
						if (!alreadyIn) {
							playersToCheck.push(lines[i]);
						}
					}    				
				}
				if (playersToCheck.length < MIN_PLAYERS) {
					document.getElementById('errorSpan').innerHTML = "Need to have at least " + MIN_PLAYERS + " players.";
					return false;
				}				
				if (playersToCheck.length > MAX_PLAYERS) {
					document.getElementById('errorSpan').innerHTML = "Only showing info for the first " + MAX_PLAYERS + " players.";
				}

				return playersToCheck.slice(0, MAX_PLAYERS);
			}


			function customGroupLaunch() {

				var input = checkInput();
				if (!input) {
					return false;
				}
				currentGroup = new Object;
				currentGroup.name = "Custom group";
				currentGroup.players = [];
				currentGroup.matches = [];

				input.forEach(function(playerName) {
					var player = new Object();
					player.name = playerName;
					currentGroup.players.push(player);
				});

				initGroup(currentGroup);
				resetPlayers(currentGroup);
				resetMatches(currentGroup);				
				calculatePlayersAttributes(currentGroup);
				sortPlayers(currentGroup);
				drawMatches(currentGroup);
				drawStandings(currentGroup);
			}

		</script>
	</head>


	<body>


		<form>
			<textarea id="playersTextArea" placeholder="Enter player names" rows="8" cols="50"></textarea>
			<input type="button" value="Submit" onclick="customGroupLaunch()"/>
			<span id="errorSpan"></span>
		</form>

		<div id="matchesTableDiv"></div>
		<div id="playersTableDiv"></div>


	</body>
</html>