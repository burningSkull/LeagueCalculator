<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">

        <title>League calculator</title>

        <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <script src="jquery.min.js"></script>
        <script src="bootstrap/js/bootstrap.min.js"></script>

        <style>            
            tr.changed {
                background: #f0f8ff;
            }

            td.highlight {
                color: #8CC101;
            }

            .matchResultUnchanged {
                visibility: hidden;
            }

            .matchResultChanged {
            }

            .matchResultChanged:hover {
                color: #8CC101;
            }            

        </style>

        <script type="text/javascript">
            const MIN_PLAYERS = 2;
                    const MAX_PLAYERS = 8;
                    const GAMES_PER_MATCH = 6;
                    const SERVLET_URL = "/JSONServlet";
                    const REQUEST_TIMEOUT = 5000;
                    const RANK_PICS_PATH = "rankpics";
                    var currentGroup;
            var standings;


            function groupSelected() {
                var select = document.getElementById("groupSelect");
                var groupName = select.options[select.selectedIndex].value;
                for (var i = 0; i < standings.length; i++) {
                    if (standings[i].name == groupName) {
                        currentGroup = standings[i];
                        initGroup(currentGroup);
                        recalculateAndRedraw(1);
                    }
                }
            }

            function fillGroupSelector() {
                var select = document.getElementById("groupSelect");
                standings.forEach(function (g) {
                    var option = document.createElement("option");
                    option.value = g.name;
                    option.text = g.name;
                    select.appendChild(option);
                });
            }

            function loadStandingsFromServer() {
                var xmlhttp = new XMLHttpRequest();
                xmlhttp.timeout = REQUEST_TIMEOUT;
                xmlhttp.ontimeout = function () {
                    document.getElementById("helloLayer").style.display = "none";
                    document.getElementById("mainLayer").style.display = "block";
                    document.getElementById("noConnection").style.display = "block";
                    document.getElementById('errorSpan').innerHTML = "Can't reach f.ds. You may enter player names manually.";
                };
                xmlhttp.onload = function () {
                    document.getElementById("helloLayer").style.display = "none";
                    document.getElementById("mainLayer").style.display = "block";
                    if (xmlhttp.readyState === 4) {
                        if (xmlhttp.status === 200) {
                            try {
                                standings = JSON.parse(xmlhttp.responseText);
                                fillGroupSelector();
                                document.getElementById("connectionEstablished").style.display = "block";
                            }
                            catch (err) {
                                document.getElementById("noConnection").style.display = "block";
                                console.error(err.message);
                                document.getElementById('errorSpan').innerHTML = "Can't connect to server. You may enter player names manually.";
                            }
                        } else {
                            document.getElementById("noConnection").style.display = "block";
                            console.error(xmlhttp.statusText);
                            document.getElementById('errorSpan').innerHTML = "Can't connect to server. You may enter player names manually.";
                        }
                    }
                };
                //xmlhttp.open("GET", "LeagueCalculator" + SERVLET_URL, true);
                xmlhttp.open("GET", "/LeagueCalculator/JSONServlet", true);
                //xmlhttp.open("GET", window.location.href + SERVLET_URL, true);
                xmlhttp.send();
            }

            function initGroup(group) {
                for (var i = 0; i < group.players.length; i++) {
                    var pA = group.players[i];
                    for (var j = 0; j < group.players.length; j++) {
                        var pB = group.players[j];
                        if (pA.name != pB.name) {
                            var found = false;
                            for (var k = 0; k < group.matches.length; k++) {
                                var m = group.matches[k];
                                if ((m.p1 == pA.name && m.p2 == pB.name) || (m.p1 == pB.name && m.p2 == pA.name)) {
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) {
                                var m = new Object();
                                m.p1 = pA.name;
                                m.p2 = pB.name;
                                m.actualResult = "Not played";
                                group.matches.push(m);
                            }
                        }
                    }
                }
            }

            function resetPlayers(group) {
                group.players.forEach(function (p) {
                    p.matchesPlayed = 0;
                    p.points = 0;
                    p.average = "-";
                    p._2nd = 0;
                    p._3rd = 0;
                });
            }

            function resetMatches(group) {
                group.matches.forEach(function (m) {
                    m.speculativeResult = m.actualResult;
                });
            }

            function resetMatch(match) {
                match.speculativeResult = match.actualResult;
                recalculateAndRedraw(3);
            }

            function recalculateAndRedraw(mode) {
                /*
                 * mode
                 * 1: reset all
                 * 2: do not reset matches
                 * 3: do not parse matches 
                 * 
                 * That code is awful, it'll be gone after i start using angular with this thing
                 */
                var group = currentGroup;
                resetPlayers(group);
                if (mode == 1)
                    resetMatches(group);
                if (mode != 3)
                    parseMatchesFromHTML(group);
                calculatePlayersAttributes(group);
                sortPlayers(group);
                document.getElementById("dataDiv").style.display = "block";
                sortMatches(group);
                drawMatches(group);
                drawStandings(group);
            }

            function parseMatchesFromHTML(group) {
                var matchesTable = document.getElementById("matchesTable");
                for (var i = 0; i < matchesTable.rows.length; i++) {
                    var matchResultElement = matchesTable.rows[i].cells[1].childNodes[0];

                    for (var j = 0; j < group.matches.length; j++) {
                        var m = group.matches[j];
                        if (m.p1 == matchResultElement.p1 && m.p2 == matchResultElement.p2) {
                            m.speculativeResult = matchResultElement.value;
                            break;
                        }
                    }
                }
            }

            function calculatePlayersAttributes(group) {
                for (var i = 0; i < group.players.length; i++) {
                    var p = group.players[i];
                    for (var j = 0; j < group.matches.length; j++) {
                        var m = group.matches[j];
                        if (m.p1 == p.name || m.p2 == p.name) {
                            if (m.speculativeResult != "Not played") {
                                p.points += ((m.p1 == p.name) ? m.speculativeResult : (GAMES_PER_MATCH - m.speculativeResult)) * 1;
                                p.matchesPlayed++;
                                p.average = p.matchesPlayed == 0 ? "-" : (p.points / p.matchesPlayed).toFixed(1);
                            }
                        }
                    }
                }

                for (var i = 0; i < group.players.length; i++) {
                    var p = group.players[i];

                    for (var j = 0; j < group.players.length; j++) {
                        if (j != i && p.points == group.players[j].points) {
                            for (var k = 0; k < group.matches.length; k++) {
                                var m = group.matches[k];
                                if (m.speculativeResult != "Not played" &&
                                        ((m.p1 == p.name && m.p2 == group.players[j].name) ||
                                                (m.p2 == p.name && m.p1 == group.players[j].name))) {
                                    p._2nd += ((m.p1 == p.name) ? m.speculativeResult : (GAMES_PER_MATCH - group.matches[k].speculativeResult)) * 1;
                                    break;
                                }
                            }
                        }
                    }

                    for (var j = 0; j < group.matches.length; j++) {
                        var m = group.matches[j];
                        if (m.p1 == p.name || m.p2 == p.name) {
                            if (m.speculativeResult != "Not played") {
                                var oppName = (m.p1 == p.name) ? m.p2 : m.p1;
                                var opp;
                                for (var k = 0; k < group.players.length; k++) {
                                    if (group.players[k].name == oppName) {
                                        opp = group.players[k];
                                        break;
                                    }
                                }
                                p._3rd += ((m.p1 == p.name) ? m.speculativeResult : (GAMES_PER_MATCH - m.speculativeResult)) * opp.points;
                            }
                        }
                    }
                }
            }

            function comparePlayers(p1, p2) {
                if (p1.average != p2.average) {
                    if (p1.average == "-")
                        return 1;
                    else if (p2.average == "-")
                        return -1;
                    else
                        return p2.average - p1.average;
                } else {
                    if (p1._2nd != p2._2nd) {
                        return p2._2nd - p1._2nd;
                    } else {
                        if (p1._3rd != p2._3rd) {
                            return p2._3rd - p1._3rd;
                        } else {
                            return p1.name > p2.name ? 1 : -1;
                        }
                    }
                }
            }

            function sortPlayers(group) {
                group.players = group.players.sort(comparePlayers);
            }

            function findPlayerByName(group, name) {
                for (var i = 0; i <= group.players.length; i++) {
                    if (group.players[i].name == name) {
                        return group.players[i];
                    }
                }
            }

            function sortMatches(group) {
                group.matches.forEach(function (m) {
                    if (comparePlayers(findPlayerByName(group, m.p1), findPlayerByName(group, m.p2)) > 0) {
                        var swap = m.p1;
                        m.p1 = m.p2;
                        m.p2 = swap;
                        if (m.actualResult != "Not played") {
                            m.actualResult = GAMES_PER_MATCH - m.actualResult;
                        }
                        if (m.speculativeResult != "Not played") {
                            m.speculativeResult = GAMES_PER_MATCH - m.speculativeResult;
                        }
                    }
                });

                group.matches = group.matches.sort(function (a, b) {
                    if (a.speculativeResult == "Not played" && b.speculativeResult != "Not played") {
                        return 1;
                    }
                    if (b.speculativeResult == "Not played" && a.speculativeResult != "Not played") {
                        return -1;
                    }

                    if (a.p1 != b.p1) {
                        return comparePlayers(findPlayerByName(group, a.p1), findPlayerByName(group, b.p1));
                    } else {
                        return comparePlayers(findPlayerByName(group, a.p2), findPlayerByName(group, b.p2));
                    }
                });
            }

            function drawMatches(group) {
                var matchesTable = document.getElementById("matchesTable");
                matchesTable.innerHTML = "";

                group.matches.forEach(function (m) {
                    var row = matchesTable.insertRow(matchesTable.rows.length);
                    row.insertCell(0).innerHTML = m.p1;


                    var results = ["Not played"];
                    for (var i = 0; i <= GAMES_PER_MATCH; i += 0.5) {
                        results.push(i);
                    }

                    var cell = row.insertCell(1);
                    var select = document.createElement("select");
                    select.p1 = m.p1;
                    select.p2 = m.p2;

                    cell.appendChild(select);

                    for (var i = 0; i < results.length; i++) {
                        var option = document.createElement("option");
                        option.value = results[i];
                        option.text = results[i];
                        select.appendChild(option);
                    }
                    select.value = m.speculativeResult;
                    select.setAttribute("onchange", "recalculateAndRedraw(2)");

                    var revertButton = document.createElement("div");
                    revertButton.innerHTML = "X";
                    revertButton.onclick = function () {
                        resetMatch(m);
                    }
                    revertButton.classList.add(m.actualResult == m.speculativeResult ? "matchResultUnchanged" : "matchResultChanged");
                    revertButton.style.paddingLeft = true;

                    row.insertCell(2).appendChild(revertButton);
                    row.insertCell(3).innerHTML = m.p2;
                    if (m.actualResult != m.speculativeResult) {
                        row.classList.add("changed");
                    }
                });
            }

            function drawStandings(group) {
                var playersTable = document.getElementById("standingsTable");
                for (var i = playersTable.rows.length - 1; i > 0; i--) {
                    playersTable.deleteRow(i);
                }

                for (var i = 0; i < group.players.length; i++) {
                    var p = group.players[i];
                    var row = playersTable.insertRow(i + 1);
                    row.insertCell(0).innerHTML = "<img src=\"" + RANK_PICS_PATH + "\\rank" + (i + 1) + ".png\">";
                    row.insertCell(1).innerHTML = p.name;
                    row.insertCell(2).innerHTML = p.average;
                    row.insertCell(3).innerHTML = p.points;
                    row.insertCell(4).innerHTML = p.matchesPlayed;
                    row.insertCell(5).innerHTML = p._2nd;
                    row.insertCell(6).innerHTML = p._3rd;
                    row.setAttribute("onmouseover", "mouseOverStandingsRow(\"" + p.name + "\");");
                    row.setAttribute("onmouseout", "mouseOutOfStandingsRow();");
                }
            }

            function mouseOverStandingsRow(playerName) {
                var matchesTable = document.getElementById("matchesTable");
                for (var i = 0; i < matchesTable.rows.length; i++) {
                    var matchResultElement = matchesTable.rows[i].cells[1].childNodes[0];
                    if (matchResultElement.p1 == playerName) {
                        matchesTable.rows[i].cells[0].classList.add("highlight");
                    }
                    if (matchResultElement.p2 == playerName) {
                        matchesTable.rows[i].cells[3].classList.add("highlight");
                    }
                }
            }

            function mouseOutOfStandingsRow() {
                var matchesTable = document.getElementById("matchesTable");
                for (var i = 0; i < matchesTable.rows.length; i++) {
                    matchesTable.rows[i].cells[0].classList.remove("highlight");
                    matchesTable.rows[i].cells[3].classList.remove("highlight");
                }
            }

            function checkInput() {
                document.getElementById("errorSpan").innerHTML = "";

                var playersToCheck = new Array();

                var lines = document.getElementById("playersTextArea").value.split('\n');
                for (var i = 0; i < lines.length; i++) {
                    if (lines[i] != "") {
                        var alreadyIn = false;
                        for (var j = 0; j < playersToCheck.length; j++) {
                            if (playersToCheck[j] == lines[i]) {
                                alreadyIn = true;
                                break;
                            }
                        }
                        if (!alreadyIn) {
                            playersToCheck.push(lines[i]);
                        }
                    }
                }
                if (playersToCheck.length < MIN_PLAYERS) {
                    document.getElementById('errorSpan').innerHTML = "Need to have at least " + MIN_PLAYERS + " players.";
                    return false;
                }
                if (playersToCheck.length > MAX_PLAYERS) {
                    document.getElementById('errorSpan').innerHTML = "Only showing info for the first " + MAX_PLAYERS + " players.";
                }

                return playersToCheck.slice(0, MAX_PLAYERS);
            }


            function customGroupLaunch() {
                document.getElementById("dataDiv").style.display = "none";
                var input = checkInput();
                if (!input) {
                    return false;
                }
                document.getElementById("dataDiv").style.display = "block";
                currentGroup = new Object;
                currentGroup.name = "Custom group";
                currentGroup.players = [];
                currentGroup.matches = [];

                input.forEach(function (playerName) {
                    var player = new Object();
                    player.name = playerName;
                    currentGroup.players.push(player);
                });

                initGroup(currentGroup);
                resetPlayers(currentGroup);
                resetMatches(currentGroup);
                calculatePlayersAttributes(currentGroup);
                sortPlayers(currentGroup);
                sortMatches(currentGroup);
                drawMatches(currentGroup);
                drawStandings(currentGroup);
            }

        </script>
    </head>


    <body onload="loadStandingsFromServer()">
        <div class="container">
            <div id="helloLayer">
                <h1>Connecting to f.ds...</h1>        
            </div>

            <div id="mainLayer" style="display: none;">
                <div class="page-header">
                    <div id="noConnection" style="display: none;">
                        <form role="form">
                            <textarea id="playersTextArea" class="form-group" placeholder="Enter player names" rows="8" cols="50"></textarea>
                            <input type="button" class="form-group" value="Submit" onclick="customGroupLaunch()" />
                        </form>
                        <span id="errorSpan"></span>
                    </div>
                    <div id="connectionEstablished" style="display: none;">
                        <select id="groupSelect" onchange="groupSelected()">
                            <option value="" selected disabled >Select your group</option>
                        </select>
                    </div>
                </div>

                <div class="row" id="dataDiv" style="display: none;">
                    <div class="col-md-6">
                        <h3>Matches</h3>
                        <table id="matchesTable" class="table"></table>
                    </div>
                    <div class="col-md-6">
                        <h3>Standings</h3>
                        <table id="standingsTable" class="table">
                            <tr>
                                <th>rank</th>
                                <th>name</th>
                                <th>average</th>
                                <th>points</th>
                                <th>#played</th>
                                <th>2nd</th>
                                <th>3rd</th>
                            </tr>
                        </table>
                    </div>
                </div>
            </div>                        
        </div>
    </body>
</html>