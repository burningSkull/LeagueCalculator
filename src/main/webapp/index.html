<html>
    <head>
        <script type="text/javascript">
            const MIN_PLAYERS = 2;
                    const MAX_PLAYERS = 8;
                    const GAMES_PER_MATCH = 6;
                    var currentGroup;
            var standings;

            function groupSelected() {
                var select = document.getElementById("groupSelect");
                var groupName = select.options[select.selectedIndex].value;
                for (var i = 0; i < standings.length; i++) {
                    if (standings[i].name == groupName) {
                        currentGroup = standings[i];
                        initGroup(currentGroup);
                        recalculateAndRedraw(true);
                    }
                }
            }

            function fillGroupSelector() {
                var select = document.getElementById("groupSelect");
                select.innerHTML = "";                
                var placeholderOption = document.createElement("option");
                placeholderOption.value = "";
                placeholderOption.text = "Select your group";
                placeholderOption.selected = true;
                placeholderOption.disabled = true;
                select.appendChild(placeholderOption);
                standings.forEach(function (g) {
                    var option = document.createElement("option");
                    option.value = g.name;
                    option.text = g.name;
                    select.appendChild(option);
                });
            }

            function loadStandingsFromServer() {
                var xmlhttp = new XMLHttpRequest();
                var url = "http://localhost:8080/LeagueCalculator/JSONServlet";
                xmlhttp.open("GET", url, false);
                xmlhttp.send();
                standings = JSON.parse(xmlhttp.responseText);
                console.log(xmlhttp.responseText);
                fillGroupSelector();
            }

            function initGroup(group) {
                for (var i = 0; i < group.players.length; i++) {
                    var pA = group.players[i];
                    for (var j = 0; j < group.players.length; j++) {
                        var pB = group.players[j];
                        if (pA.name != pB.name) {
                            var found = false;
                            for (var k = 0; k < group.matches.length; k++) {
                                var m = group.matches[k];
                                if ((m.p1 == pA.name && m.p2 == pB.name) || (m.p1 == pB.name && m.p2 == pA.name)) {
                                    found = true;
                                    break;
                                }
                            }
                            if (!found) {
                                var m = new Object();
                                m.p1 = pA.name;
                                m.p2 = pB.name;
                                m.actualResult = "Not played";
                                group.matches.push(m);
                            }
                        }
                    }
                }
            }

            function resetPlayers(group) {
                group.players.forEach(function (p) {
                    p.matchesPlayed = 0;
                    p.points = 0;
                    p.average = "-";
                    p._2nd = 0;
                    p._3rd = 0;
                });
            }

            function resetMatches(group) {
                group.matches.forEach(function (m) {
                    m.speculativeResult = m.actualResult;
                });
            }

            function recalculateAndRedraw(reset) {
                var group = currentGroup;
                resetPlayers(group);
                if (reset) 
                    resetMatches(group)
                parseMatchesFromHTML(group);
                calculatePlayersAttributes(group);
                sortPlayers(group);
                sortMatches(group);
                drawMatches(group);
                drawStandings(group);
            }

            function parseMatchesFromHTML(group) {
                var matchesTable = document.getElementById('matchesTable');
                if (matchesTable != null) {
                    for (var i = 0; i < matchesTable.rows.length; i++) {
                        var matchResultElement = matchesTable.rows[i].cells[1].childNodes[0];

                        for (var j = 0; j < group.matches.length; j++) {
                            var m = group.matches[j];
                            if (m.p1 == matchResultElement.p1 && m.p2 == matchResultElement.p2) {
                                m.speculativeResult = matchResultElement.value;
                                break;
                            }
                        }
                    }
                }
            }

            function calculatePlayersAttributes(group) {
                for (var i = 0; i < group.players.length; i++) {
                    var p = group.players[i];
                    for (var j = 0; j < group.matches.length; j++) {
                        var m = group.matches[j];
                        if (m.p1 == p.name || m.p2 == p.name) {
                            if (m.speculativeResult != "Not played") {
                                p.points += ((m.p1 == p.name) ? m.speculativeResult : (GAMES_PER_MATCH - m.speculativeResult)) * 1;
                                p.matchesPlayed++;
                                p.average = p.matchesPlayed == 0 ? "-" : (p.points / p.matchesPlayed).toFixed(1);
                            }
                        }
                    }
                }

                for (var i = 0; i < group.players.length; i++) {
                    var p = group.players[i];

                    for (var j = 0; j < group.players.length; j++) {
                        if (j != i && p.points == group.players.points) {
                            for (var k = 0; k < group.matches.length; k++) {
                                var m = group.matches[k];
                                if (m.speculativeResult != "Not played" &&
                                        ((m.p1 == p.name && m.p2 == group.players[j].name) ||
                                                (m.p2 == p.name && m.p1 == group.players[j].name))) {
                                    p._2nd += ((m.p1 == p.name) ? m.speculativeResult : (GAMES_PER_MATCH - matches[k].speculativeResult)) * 1;
                                    break;
                                }
                            }
                        }
                    }

                    for (var j = 0; j < group.matches.length; j++) {
                        var m = group.matches[j];
                        if (m.p1 == p.name || m.p2 == p.name) {
                            if (m.speculativeResult != "Not played") {
                                var oppName = (m.p1 == p.name) ? m.p2 : m.p1;
                                var opp;
                                for (var k = 0; k < group.players.length; k++) {
                                    if (group.players[k].name == oppName) {
                                        opp = group.players[k];
                                        break;
                                    }
                                }
                                p._3rd += ((m.p1 == p.name) ? m.speculativeResult : (GAMES_PER_MATCH - m.speculativeResult)) * opp.points;
                            }
                        }
                    }
                }
            }

            function comparePlayers(p1, p2) {
                if (p1.average != p2.average) {
                    if (p1.average == "-")
                        return 1;
                    else if (p2.average == "-")
                        return -1;
                    else
                        return p2.average - p1.average;
                } else {
                    if (p1._2nd != p2._2nd) {
                        return p2._2nd - p1._2nd;
                    } else {
                        if (p1._3rd != p2._3rd) {
                            return p2._3rd - p1._3rd;
                        } else {
                            return p1.name > p2.name ? 1 : -1;
                        }
                    }
                }
            }

            function sortPlayers(group) {
                group.players = group.players.sort(comparePlayers);
            }

            function findPlayerByName(group, name) {
                for (var i = 0; i <= group.players.length; i++) {
                    if (group.players[i].name == name) {
                        return group.players[i];
                    }
                }
            }

            function sortMatches(group) {
                group.matches.forEach(function (m) {
                    if (comparePlayers(findPlayerByName(group, m.p1), findPlayerByName(group, m.p2)) > 0) {
                        var swap = m.p1;
                        m.p1 = m.p2;
                        m.p2 = swap;
                        if (m.actualResult != "Not played") {
                            m.actualResult = GAMES_PER_MATCH - m.actualResult;
                        }
                        if (m.speculativeResult != "Not played") {
                            m.speculativeResult = GAMES_PER_MATCH - m.speculativeResult;
                        }
                    }
                });

                group.matches = group.matches.sort(function (a, b) {
                    if (a.speculativeResult == "Not played" && b.speculativeResult != "Not played") {
                        return 1;
                    }
                    if (b.speculativeResult == "Not played" && a.speculativeResult != "Not played") {
                        return -1;
                    }

                    if (a.p1 != b.p1) {
                        return comparePlayers(findPlayerByName(group, a.p1), findPlayerByName(group, b.p1));
                    } else {
                        return comparePlayers(findPlayerByName(group, a.p2), findPlayerByName(group, b.p2));
                    }
                });
            }

            function drawMatches(group) {
                document.getElementById('matchesTableDiv').innerHTML = "<table id=\"matchesTable\"></table>";
                var matchesTable = document.getElementById('matchesTable');

                group.matches.forEach(function (m) {
                    var row = matchesTable.insertRow(matchesTable.rows.length);
                    row.insertCell(0).innerHTML = m.p1;


                    var results = ["Not played"];
                    for (var i = 0; i <= GAMES_PER_MATCH; i += 0.5) {
                        results.push(i);
                    }

                    var cell = row.insertCell(1);
                    var select = document.createElement("select");
                    select.p1 = m.p1;
                    select.p2 = m.p2;

                    cell.appendChild(select);

                    for (var i = 0; i < results.length; i++) {
                        var option = document.createElement("option");
                        option.value = results[i];
                        option.text = results[i];
                        select.appendChild(option);
                    }
                    select.value = m.speculativeResult;
                    select.setAttribute('onchange', 'recalculateAndRedraw(false)');

                    row.insertCell(2).innerHTML = m.p2;
                });
            }

            function drawStandings(group) {
                var playersTableHTML = "<table id=\"playersTable\"><tr>"
                        + "<th>rank</th>"
                        + "<th>name</th>"
                        + "<th>average</th>"
                        + "<th>points</th>"
                        + "<th>#played</th>"
                        + "<th>2nd</th>"
                        + "<th>3rd</th>"
                        + "</tr></table>";
                document.getElementById('playersTableDiv').innerHTML = playersTableHTML;

                var playersTable = document.getElementById('playersTable');
                for (var i = playersTable.rows.length - 1; i > 0; i--) {
                    playersTable.deleteRow(i);
                }
                for (var i = 0; i < group.players.length; i++) {
                    var p = group.players[i];
                    var row = playersTable.insertRow(i + 1);
                    row.insertCell(0).innerHTML = i + 1;
                    row.insertCell(1).innerHTML = p.name;
                    row.insertCell(2).innerHTML = p.average;
                    row.insertCell(3).innerHTML = p.points;
                    row.insertCell(4).innerHTML = p.matchesPlayed;
                    row.insertCell(5).innerHTML = p._2nd;
                    row.insertCell(6).innerHTML = p._3rd;
                }
            }


            function checkInput() {
                document.getElementById('errorSpan').innerHTML = "";

                var playersToCheck = new Array();

                var lines = document.getElementById('playersTextArea').value.split('\n');
                for (var i = 0; i < lines.length; i++) {
                    if (lines[i] != "") {
                        var alreadyIn = false;
                        for (var j = 0; j < playersToCheck.length; j++) {
                            if (playersToCheck[j] == lines[i]) {
                                alreadyIn = true;
                                break;
                            }
                        }
                        if (!alreadyIn) {
                            playersToCheck.push(lines[i]);
                        }
                    }
                }
                if (playersToCheck.length < MIN_PLAYERS) {
                    document.getElementById('errorSpan').innerHTML = "Need to have at least " + MIN_PLAYERS + " players.";
                    return false;
                }
                if (playersToCheck.length > MAX_PLAYERS) {
                    document.getElementById('errorSpan').innerHTML = "Only showing info for the first " + MAX_PLAYERS + " players.";
                }

                return playersToCheck.slice(0, MAX_PLAYERS);
            }


            function customGroupLaunch() {

                var input = checkInput();
                if (!input) {
                    return false;
                }
                currentGroup = new Object;
                currentGroup.name = "Custom group";
                currentGroup.players = [];
                currentGroup.matches = [];

                input.forEach(function (playerName) {
                    var player = new Object();
                    player.name = playerName;
                    currentGroup.players.push(player);
                });

                initGroup(currentGroup);
                resetPlayers(currentGroup);
                resetMatches(currentGroup);
                calculatePlayersAttributes(currentGroup);
                sortPlayers(currentGroup);
                sortMatches(currentGroup);
                drawMatches(currentGroup);
                drawStandings(currentGroup);
            }

        </script>
    </head>


    <body>
        <select id="groupSelect" onchange="groupSelected()">
        </select>        

        <input type="button" value="TEST" onclick="loadStandingsFromServer()"/>
        <form>
            <textarea id="playersTextArea" placeholder="Enter player names" rows="8" cols="50"></textarea>
            <input type="button" value="Submit" onclick="customGroupLaunch()"/>
            <span id="errorSpan"></span>
        </form>

        <div id="matchesTableDiv"></div>
        <div id="playersTableDiv"></div>


    </body>
</html>